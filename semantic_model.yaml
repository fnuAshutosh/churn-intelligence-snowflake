name: BankCo Churn Intelligence
description: >
  Semantic model for the BankCo Churn Intelligence Platform.
  Enables Cortex Analyst to answer natural language questions about
  customer churn risk, transaction patterns, and AI-generated interventions.

tables:
  - name: DYN_CHURN_PREDICTIONS
    description: >
      Real-time churn risk scores for all customers, refreshed automatically
      every 5 minutes by a Snowflake Dynamic Table.
    base_table: CHURN_DEMO.PUBLIC.DYN_CHURN_PREDICTIONS
    primary_key: CUSTOMER_ID
    dimensions:
      - name: CUSTOMER_ID
        description: Unique customer identifier
        expr: CUSTOMER_ID
        data_type: TEXT
      - name: FULL_NAME
        description: Customer full name
        expr: FULL_NAME
        data_type: TEXT
      - name: SEGMENT
        description: Customer segment (Young Professional, Student, Established, High Net Worth)
        expr: SEGMENT
        data_type: TEXT
      - name: EMAIL
        description: Customer email address
        expr: EMAIL
        data_type: TEXT
      - name: RISK_CLASS
        description: Churn risk classification â€” HIGH (>=0.7), MEDIUM (>=0.4), LOW (<0.4)
        expr: RISK_CLASS
        data_type: TEXT
    measures:
      - name: CHURN_SCORE
        description: Churn probability score from 0.0 (no risk) to 1.0 (certain churn)
        expr: CHURN_SCORE
        data_type: NUMBER
        agg: AVG
      - name: CUSTOMER_COUNT
        description: Number of customers
        expr: CUSTOMER_ID
        data_type: NUMBER
        agg: COUNT_DISTINCT
    time_dimensions:
      - name: COMPUTED_AT
        description: When the churn score was last computed
        expr: COMPUTED_AT
        data_type: TIMESTAMP

  - name: DIM_CUSTOMERS
    description: Customer master data including segment and join date.
    base_table: CHURN_DEMO.PUBLIC.DIM_CUSTOMERS
    primary_key: CUSTOMER_ID
    dimensions:
      - name: CUSTOMER_ID
        expr: CUSTOMER_ID
        data_type: TEXT
      - name: FULL_NAME
        expr: FULL_NAME
        data_type: TEXT
      - name: SEGMENT
        expr: SEGMENT
        data_type: TEXT
      - name: EMAIL
        expr: EMAIL
        data_type: TEXT
    measures:
      - name: TOTAL_CUSTOMERS
        expr: CUSTOMER_ID
        data_type: NUMBER
        agg: COUNT_DISTINCT
    time_dimensions:
      - name: JOIN_DATE
        expr: JOIN_DATE
        data_type: DATE

  - name: AGENT_INTERVENTION_LOG
    description: >
      Log of AI-generated retention emails sent to high-risk customers.
      Each row is one email generated by Cortex LLM (llama3-8b).
    base_table: CHURN_DEMO.PUBLIC.AGENT_INTERVENTION_LOG
    primary_key: INTERVENTION_ID
    dimensions:
      - name: INTERVENTION_ID
        expr: INTERVENTION_ID
        data_type: TEXT
      - name: CUSTOMER_ID
        expr: CUSTOMER_ID
        data_type: TEXT
      - name: GENERATED_EMAIL
        description: Full text of the AI-generated retention email
        expr: GENERATED_EMAIL
        data_type: TEXT
    measures:
      - name: CHURN_SCORE_AT_INTERVENTION
        expr: CHURN_SCORE
        data_type: NUMBER
        agg: AVG
      - name: EMAILS_SENT
        expr: INTERVENTION_ID
        data_type: NUMBER
        agg: COUNT
    time_dimensions:
      - name: CREATED_AT
        expr: CREATED_AT
        data_type: TIMESTAMP

  - name: APP_ACTIVITY_LOGS
    description: >
      App activity events including errors. Used by Cortex Search for
      unstructured log queries.
    base_table: CHURN_DEMO.PUBLIC.APP_ACTIVITY_LOGS
    primary_key: LOG_ID
    dimensions:
      - name: LOG_ID
        expr: LOG_ID
        data_type: TEXT
      - name: CUSTOMER_ID
        expr: CUSTOMER_ID
        data_type: TEXT
      - name: EVENT_TYPE
        expr: EVENT_TYPE
        data_type: TEXT
      - name: DEVICE_OS
        expr: DEVICE_OS
        data_type: TEXT
      - name: ERROR_CODE
        expr: ERROR_CODE
        data_type: TEXT
    measures:
      - name: ERROR_COUNT
        description: Number of error events
        expr: CASE WHEN ERROR_CODE IS NOT NULL THEN 1 ELSE 0 END
        data_type: NUMBER
        agg: SUM
      - name: EVENT_COUNT
        expr: LOG_ID
        data_type: NUMBER
        agg: COUNT
    time_dimensions:
      - name: EVENT_TIMESTAMP
        expr: EVENT_TIMESTAMP
        data_type: TIMESTAMP

relationships:
  - name: predictions_to_customers
    left_table: DYN_CHURN_PREDICTIONS
    right_table: DIM_CUSTOMERS
    relationship_type: many_to_one
    left_join_key: CUSTOMER_ID
    right_join_key: CUSTOMER_ID

  - name: interventions_to_customers
    left_table: AGENT_INTERVENTION_LOG
    right_table: DIM_CUSTOMERS
    relationship_type: many_to_one
    left_join_key: CUSTOMER_ID
    right_join_key: CUSTOMER_ID

  - name: logs_to_customers
    left_table: APP_ACTIVITY_LOGS
    right_table: DIM_CUSTOMERS
    relationship_type: many_to_one
    left_join_key: CUSTOMER_ID
    right_join_key: CUSTOMER_ID
